name: Deploy K3s & Register with ArgoCD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted   # because your runner is Windows

    steps:
    - uses: actions/checkout@v4

    - name: Terraform Init & Apply
      id: tf
      shell: bash
      run: |
        terraform init
        terraform apply -auto-approve
        echo "server_ip=$(terraform output -raw server_ip)" >> $GITHUB_OUTPUT

    - name: Download kubeconfig
      shell: bash
      run: |
        scp -o StrictHostKeyChecking=no `
          root@${{ steps.tf.outputs.server_ip }}:/etc/rancher/k3s/k3s.yaml `
          k3s.yaml

    - name: Verify kubectl can connect
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        kubectl get nodes

    - name: Create bootstrap SA + token
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        kubectl apply -f k8s/bootstrap-sa.yaml

    - name: Extract token & CA
      id: creds
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        TOKEN=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data.token}" | base64 -d)
        CA=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data['ca.crt']}")
        SERVER="https://${{ steps.tf.outputs.server_ip }}:6443"

        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "ca=$CA" >> $GITHUB_OUTPUT
        echo "server=$SERVER" >> $GITHUB_OUTPUT

    - name: Install ArgoCD CLI (Windows)
      shell: powershell
      run: |
        Invoke-WebRequest `
          -Uri "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-windows-amd64.exe" `
          -OutFile "argocd.exe"

    - name: Login to ArgoCD
      shell: powershell
      run: |
        .\argocd.exe login $env:ARGOCD_SERVER `
          --username $env:ARGOCD_USERNAME `
          --password $env:ARGOCD_PASSWORD `
          --insecure

    - name: Register cluster in ArgoCD
      shell: powershell
      run: |
        .\argocd.exe cluster add `
          --name "k3s-${{ github.run_id }}" `
          --kubeconfig "$PWD/k3s.yaml" `
          --yes
