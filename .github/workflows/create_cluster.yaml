name: Deploy K3s & Register with ArgoCD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted   # Windows runner
    outputs:
      server_ip: ${{ steps.tf.outputs.server_ip }}

    steps:
    - uses: actions/checkout@v4

    - name: Write SSH private key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.TF_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Write terraform.tfvars
      shell: bash
      run: |
        cat <<EOF > terraform/terraform.tfvars
        linode_token    = "${{ secrets.TF_LINODE_TOKEN }}"
        root_pass       = "${{ secrets.TF_ROOT_PASS }}"
        ssh_key         = "${{ secrets.TF_SSH_KEY }}"
        home_ip         = "${{ secrets.TF_HOME_IP }}"
        private_key_path = "$HOME/.ssh/id_rsa"
        k3s_token       = "${{ secrets.TF_K3S_TOKEN }}"
        argocd_url      = "${{ secrets.ARGOCD_URL }}"
        argocd_ip       = "${{ secrets.ARGOCD_IP }}"
        argocd_password = "${{ secrets.ARGOCD_PASSWORD }}"
        EOF

    - name: Terraform Init & Apply
      id: tf
      run: |
        cd terraform
        terraform init
        terraform apply -auto-approve
        echo "server_ip=$(terraform output -raw server_ip)" >> $GITHUB_OUTPUT

  configure_k3s:
    runs-on: self-hosted
    needs: deploy
    outputs:
      token: ${{ steps.creds.outputs.token }}
      ca: ${{ steps.creds.outputs.ca }}
      server: ${{ steps.creds.outputs.server }}

    steps:
    - uses: actions/checkout@v4

    - name: Download kubeconfig
      shell: powershell
      run: |
        scp.exe -o StrictHostKeyChecking=no `
        "root@${{ needs.deploy.outputs.server_ip }}:/etc/rancher/k3s/k3s.yaml" `
        "k3s.yaml"

    - name: Verify kubectl connectivity
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        kubectl get nodes

    - name: Create bootstrap SA + token
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: argocd-bootstrap
          namespace: kube-system
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: argocd-bootstrap-token
          namespace: kube-system
          annotations:
            kubernetes.io/service-account.name: argocd-bootstrap
        type: kubernetes.io/service-account-token
        EOF

    - name: Extract token & CA
      id: creds
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml

        TOKEN=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data.token}" | base64 -d)
        CA=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data['ca.crt']}")
        SERVER="https://${{ needs.deploy.outputs.server_ip }}:6443"

        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "ca=$CA" >> $GITHUB_OUTPUT
        echo "server=$SERVER" >> $GITHUB_OUTPUT

    - name: Save kubeconfig for next job
      shell: powershell
      run: |
        Copy-Item k3s.yaml "$env:GITHUB_WORKSPACE\k3s.yaml"

  configure_argocd:
    runs-on: self-hosted
    needs: configure_k3s

    steps:
    - uses: actions/checkout@v4

    - name: Restore kubeconfig
      shell: powershell
      run: |
        Copy-Item "$env:GITHUB_WORKSPACE\k3s.yaml" "k3s.yaml"

    - name: Install ArgoCD CLI (Windows)
      shell: powershell
      run: |
        Invoke-WebRequest `
          -Uri "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-windows-amd64.exe" `
          -OutFile "argocd.exe"

    - name: Login to ArgoCD
      shell: powershell
      run: |
        .\argocd.exe login $env:ARGOCD_SERVER `
          --username $env:ARGOCD_USERNAME `
          --password $env:ARGOCD_PASSWORD `
          --insecure

    - name: Register cluster in ArgoCD
      shell: powershell
      run: |
        .\argocd.exe cluster add `
          --name "k3s-${{ github.run_id }}" `
          --kubeconfig "$PWD/k3s.yaml" `
          --yes
