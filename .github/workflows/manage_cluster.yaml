name: Manage Cluster

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose apply or destroy"
        type: choice
        options:
          - apply
          - destroy

jobs:

  ###########################################################################
  # APPLY WORKFLOW
  ###########################################################################
  apply:
    if: ${{ github.event.inputs.action == 'apply' }}
    runs-on: Linux
    outputs:
      server_ip: ${{ steps.tf.outputs.server_ip }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      AWS_EC2_METADATA_DISABLED: true
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Write SSH private key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.TF_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Write terraform.tfvars
      shell: bash
      run: |
        mkdir -p terraform
        cat <<EOF > terraform/terraform.tfvars
        linode_token    = "${{ secrets.LINODE_TOKEN }}"
        root_pass       = "${{ secrets.ROOT_PASS }}"
        ssh_key         = "${{ secrets.SSH_KEY }}"
        private_key_path = "$HOME/.ssh/id_rsa"
        k3s_token       = "${{ secrets.K3S_TOKEN }}"
        argocd_url      = "${{ secrets.ARGOCD_URL }}"
        argocd_ip       = "${{ secrets.ARGOCD_IP }}"
        argocd_password = "${{ secrets.ARGOCD_PASSWORD }}"
        minio_url       = "${{ secrets.MINIO_URL }}"
        EOF

    - name: Terraform Init & Apply
      id: tf
      shell: bash
      run: |
        cd terraform
        terraform init
        terraform apply -auto-approve
        echo "server_ip=$(terraform output -raw server_ip)" >> $GITHUB_OUTPUT

  ###########################################################################
  # CONFIGURE K3S
  ###########################################################################
  configure_k3s:
    if: ${{ github.event.inputs.action == 'apply' }}
    runs-on: Linux
    needs: apply
    outputs:
      token: ${{ steps.creds.outputs.token }}
      ca: ${{ steps.creds.outputs.ca }}
      server: ${{ steps.creds.outputs.server }}

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Write SSH private key again (same key needed)
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.TF_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Download kubeconfig from server
      shell: bash
      run: |
        ssh -o StrictHostKeyChecking=no \
          root@${{ needs.apply.outputs.server_ip }} -i ~/.ssh/id_rsa_rgbdesktop \
          'cat /etc/rancher/k3s/k3s.yaml' > k3s.yaml

    - name: Fix server IP & test kubectl
      shell: bash
      run: |
        sed -i "s/127\.0\.0\.1/${{ needs.apply.outputs.server_ip }}/g" ./k3s.yaml
        export KUBECONFIG=$PWD/k3s.yaml
        kubectl get nodes

    - name: Create bootstrap SA + token
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: argocd-bootstrap
          namespace: kube-system
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: argocd-bootstrap-token
          namespace: kube-system
          annotations:
            kubernetes.io/service-account.name: argocd-bootstrap
        type: kubernetes.io/service-account-token
        EOF

    - name: Extract token & CA
      id: creds
      shell: bash
      run: |
        export KUBECONFIG=$PWD/k3s.yaml
        TOKEN=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data.token}" | base64 -d)
        CA=$(kubectl get secret argocd-bootstrap-token -n kube-system -o jsonpath="{.data['ca.crt']}")
        SERVER="https://${{ needs.apply.outputs.server_ip }}:6443"

        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "ca=$CA" >> $GITHUB_OUTPUT
        echo "server=$SERVER" >> $GITHUB_OUTPUT

    - name: Upload kubeconfig artifact
      uses: actions/upload-artifact@v4
      with:
        name: kubeconfig
        path: k3s.yaml

  ###########################################################################
  # CONFIGURE ARGOCD
  ###########################################################################
  configure_argocd:
    if: ${{ github.event.inputs.action == 'apply' }}
    runs-on: Linux
    needs: configure_k3s
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      AWS_EC2_METADATA_DISABLED: true
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Download kubeconfig artifact
      uses: actions/download-artifact@v4
      with:
        name: kubeconfig

    - name: Login to ArgoCD
      shell: bash
      run: |
        argocd login ${{ secrets.ARGOCD_SERVER }} \
          --username ${{ secrets.ARGOCD_USERNAME }} \
          --password ${{ secrets.ARGOCD_PASSWORD }} \
          --insecure

    - name: Register cluster in ArgoCD
      shell: bash
      run: |
        kubectl config --kubeconfig=k3s.yaml rename-context $(kubectl config --kubeconfig=k3s.yaml current-context) k3s
        kubectl config --kubeconfig=k3s.yaml use-context k3s
        argocd cluster add k3s --kubeconfig k3s.yaml --yes

  ###########################################################################
  # DESTROY WORKFLOW
  ###########################################################################
  destroy:
    if: ${{ github.event.inputs.action == 'destroy' }}
    runs-on: Linux

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      AWS_EC2_METADATA_DISABLED: true

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Write terraform.tfvars
      shell: bash
      run: |
        mkdir -p terraform
        cat <<EOF > terraform/terraform.tfvars
        linode_token    = "${{ secrets.LINODE_TOKEN }}"
        root_pass       = "${{ secrets.ROOT_PASS }}"
        ssh_key         = "${{ secrets.SSH_KEY }}"
        private_key_path = "$HOME/.ssh/id_rsa_rgbdekstop"
        k3s_token       = "${{ secrets.K3S_TOKEN }}"
        argocd_url      = "${{ secrets.ARGOCD_URL }}"
        argocd_ip       = "${{ secrets.ARGOCD_IP }}"
        argocd_password = "${{ secrets.ARGOCD_PASSWORD }}"
        minio_url       = "${{ secrets.MINIO_URL }}"
        EOF

    - name: Terraform Init
      shell: bash
      run: |
        cd terraform
        terraform init

    - name: Terraform Destroy
      shell: bash
      run: |
        cd terraform
        terraform destroy -auto-approve

    - name: Login to ArgoCD
      shell: bash
      run: |
        argocd login ${{ secrets.ARGOCD_SERVER }} \
          --username ${{ secrets.ARGOCD_USERNAME }} \
          --password ${{ secrets.ARGOCD_PASSWORD }} \
          --insecure

    - name: Remove cluster in ArgoCD
      shell: bash
      run: |
        argocd cluster rm k3s --yes