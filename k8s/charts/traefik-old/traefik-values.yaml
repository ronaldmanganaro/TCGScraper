# Configure Network Ports and EntryPoints
# EntryPoints are the network listeners for incoming traffic.
ports:
  # Defines the HTTP entry point named 'web'
  web:
    port: 80
    nodePort: 30000
    # Instructs this entry point to redirect all traffic to the 'websecure' entry point
    redirections:
      entryPoint:
        to: websecure
        scheme: https
        permanent: true

  # Defines the HTTPS entry point named 'websecure'
  websecure:
    port: 443
    nodePort: 30002

# Enables the dashboard in Secure Mode
api:
  dashboard: true
  insecure: false

ingressRoute:
  dashboard:
    enabled: true
    matchRule: Host(`tcg-toolkit.com`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
    entryPoints:
      - websecure
    middlewares:
      - name: dashboard-auth
  streamlit:
    enabled: true
    matchRule: Host(`tcg-toolkit.com`) && PathPrefix(`/`)
    entryPoints:
      - websecure
    service:
      name: streamlit-service
      port: 8501
    middlewares:
      - name: streamlit-sticky
  

  

# Creates a BasiAuth Middleware and Secret for the Dashboard Security
extraObjects:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: dashboard-auth-secret
    type: kubernetes.io/basic-auth
    stringData:
      username: admin
      password: "password"      # Replace with an Actual Password
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: dashboard-auth
    spec:
      basicAuth:
        secret: dashboard-auth-secret
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: streamlit-sticky
      namespace: streamlit
    spec:
      stickySession:
        cookieName: streamlit-sticky
        secure: true
        httpOnly: true
        # domain: tcg-toolkit.com   # Uncomment if you want to set the domain  

service: 
  sticky:
    cookie:
      name: streamlit-sticky
      secure: true
      domain: tcg-toolkit.com
      httpOnly: true

# We will route with Gateway API instead.
ingressClass:
  enabled: true

# Enable Gateway API Provider & Disables the KubernetesIngress provider
# Providers tell Traefik where to find routing configuration.
providers:
  kubernetesIngress:
     enabled: true
  kubernetesGateway:
     enabled: true

## Gateway Listeners
gateway:
  listeners:
    web:           # HTTP listener that matches entryPoint `web`
      port: 80
      protocol: HTTP
      namespacePolicy: All

    websecure:         # HTTPS listener that matches entryPoint `websecure`
      port: 443
      protocol: HTTPS  # TLS terminates inside Traefik
      namespacePolicy: All
      mode: Terminate
      certificateRefs:
        - kind: Secret
          name: traefik-tls   # This should be the name of a valid TLS secret in the kube-system namespace
          group: ""

certificatesResolvers:
  myresolver:
    acme:
      email: ronaldmanganaro@gmail.com
      storage: /data/acme.json
      dnsChallenge:
        provider: godaddy
        delayBeforeCheck: 0

# additionalArguments:
#   - "--certificatesresolvers.le.acme.email=ronaldmanganaro@gmail.com"
#   - "--certificatesresolvers.le.acme.storage=/data/acme.json"
#   - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"

persistence:
  enabled: true
  path: /data
  size: 128Mi
  accessMode: ReadWriteOnce

# Enable Observability
logs:
  general:
    level: INFO
  # This enables access logs, outputting them to Traefik's standard output by default. The [Access Logs Documentation](https://doc.traefik.io/traefik/observability/access-logs/) covers formatting, filtering, and output options.
  access:
    enabled: true

# Enables Prometheus for Metrics
metrics:
  prometheus:
    enabled: true

env:
  - name: GODADDY_API_KEY
    value: "AQAzJcvgMiM_2kdRCuuCuwon9rRH9Z1v5b"
  - name: GODADDY_API_SECRET
    value: "JQcESRjiwegMfvkYT9Jzo7"
